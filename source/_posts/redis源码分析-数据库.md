---
title: Redis源码分析-数据库
date: 2019-02-21 20:19:14
tags: [C,Redis,读书笔记]
toc: true
---

《Redis设计与实现》读书笔记，[推荐去看作者原著](http://redisbook.com/)

## redisServer
redis.h/redisServer

```c
struct redisServer{
    // ...
    // 一个保存着服务器中所有数据库的数组
    redisDb *db;
    // 服务器的数据库数量
    int dbnum;
    // ....

};
```
<!-- more -->
初始化时，程序会根据dbnum属性来决定创建的数据库数量。dbnum属性由服务器配置的database选项决定，默认为16。

## redisClient

```c
struct redisClient{
    // ...
    // 记录客户端当前正在使用的数据库
    redisDb *db;
    // ...
};
```
使用[select id]命令即可切换数据库。

## redisDb

```c
struct redisDb {
    // ...
    // 数据库键空间，保存着数据库中所有的键值对
    dict *dict;
    // 保存着数据库键的过期时间
    dict *expires;
    // ...
}
```

## 键的增删改查

    set data "2013.12.1" //修改或添加
    del book //删除
    get key  //获取
    hset book page 200 //设置键book的hash对象中的page键值为200

## 读写键空间的维护操作
* 在操作一个键后，服务器会根据键是否存在来更新服务器的键空间命中次数和空间命中次数，这两个值可以在info stats命令的keyspace_hits属性和keyspace_misses属性中查看。
* 在读取一个键后，服务器会更新键的最后一次使用时间，这个用于计算键的闲置时间，使用object idletime命令查看。
* 若服务器读取一个过期键，服务器会先删除这个过期键然后再执行余下操作。
* 若修改了被客户端watch的被监视键，则该键会被标记为脏键并让实物程序注意到。
* 服务器修改一个键后，都会对脏键计数器+1，计数器会触发服务器的持久化以及复制操作。
* 若服务器开启了数据库的通知功能，那么对键修改之后服务器将按配置发送相应的数据库通知。

## 修改生存时间或过期时间
通过expire或pexpire命令，客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间（Time To Live,TTL)，在经过指定的秒数或者毫秒之后，服务器就会自动删除生存时间为0的键。setex命令原理和expire原理相同。

    expire <key> <ttl>  //用于将key的生存周期设置为ttl秒
    pexpire <key> <ttl>  //用于将key的生存周期设置 为ttl毫秒
    expireat <key> <timestamp>  //设置为timestamp指定秒数时间戳
    pexpireat <key> <timestamp>  //设置为timestamp指定毫秒数时间戳

以上命令都是采用pexpireat命令来实现

    persist <key> //解除key的过期时间

## 过期删除策略
1. 定时删除  用定时器删除，实时性高，效率低
2. 惰性删除  操作键时才检查是否过期并进行过期删除（被动删除），效率高但是会造成内存积压
3. 定期删除  程序定期对数据库进行一次检查，折中手段，需要根据应用场景做对应配置

* 生成RDB文件时，过期键不会生效。
* 载入RDB文件时，若以主服务器模式运行，则过期键不会生效；若以服务器模式运行，则会载入，并在和主服务器同步之后被清空。
* AOF文件写入时，过期数据会被正常写入，并在过期数据被删除后，程序会向AOF文件追加删除命令。
* AOF重写和生成RDB文件类似。
* 当服务器以复制模式运行，从服务器的过期键删除动作由主服务器控制。主服务器在删除一个过期键后，会显式的向所有从服务器发送删除命令。
* 从服务器在执行客户端发送的读命令时，即使碰到过期键也不会删除，而是继续像处理未过期的键一样处理过期键。从服务器只有接收到主服务器的删除命令才会删除过期键。
* 通过主服务器来控制从服务器统一地删除过期键，可以保证服务器数据的主从一致性。

## 数据库通知



